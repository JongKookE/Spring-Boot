<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<h1>Student 관리</h1>
	<hr>
	<table>
		<thead>
			<tr><td>StudentId</td><td>StudentNm</td><td>Email</td><td>Phone</td></tr>
		</thead>
		<tbody id = "tbodyStudent"></tbody>
	</table>
	
	<hr>
	<table>
		<tbody>
			<tr><td>StudentNm</td><td><input type="text" name="studentNm" id="inputStudentNm"></td></tr>
			<tr><td>Email</td><td><input type="text" name="email" id = "inputEmail"></td></tr>
			<tr><td>Phone</td><td><input type="text" name="phone" id = "inputPhone"></td></tr>
		</tbody>
	</table>
	
	<div style="border: 1px; margin:auto; text-align:center;">
		<button id="btnInsert">등록</button>
		<button id="btnUpdate">수정</button>
		<button id="btnDelete">삭제</button>
		<button id="btnClear">초기화</button>
		<button id="btnSort">정렬</button>
	</div>
	<!--  소스폴더 안에 로그 위치시키면 스프링 DB가 변화를 감지해서 리프레쉬를 하면서 또 로그가 업데이트 되는 무한루프가 발생한다 -->
	<script>
		var CURRENT_ID; // 현재 조회되는 학생의 KEY
		
	
		window.onload = function(){
			listStudent();	
			
			document.querySelector("#btnInsert").onclick = insertStudent;
			document.querySelector("#btnUpdate").onclick = updateStudent;
			document.querySelector("#btnDelete").onclick = deleteStudent;
			document.querySelector("#btnClear").onclick = clear;
			document.querySelector("#btnSort").onclick = sortStudent;
		}
		
		
		async function listStudent(){
			try{
				let response = await fetch('/students');
				let data = await response.json();
				// data로 이후 비동기 처리 결과
				makeListHtml(data);
				console.log(data);
				clear();
			}catch(error){
				console.error(error);
			}				
		}
		
		function makeListHtml(list){
			console.log("실행되고있나");
			let listHtml = ``;
			list.forEach(el => {
				listHtml += `<tr style="cursor:pointer;" data-studentId=${el.studentId}><td>${el.studentId}</td><td>${el.studentNm}</td><td>${el.email}</td><td>${el.phone}</td></tr>`
			});
			document.querySelector("#tbodyStudent").innerHTML = listHtml;
			makeListHtmlEventHandler();
		}
		
		function makeListHtmlEventHandler(){
			document.querySelectorAll("#tbodyStudent tr").forEach(el => {
				el.onclick = function(){
					let studentId = this.getAttribute("data-studentId");
					detailStudent(studentId);
				}
			})
		}
		
		async function detailStudent(studentId){
			let url = `students/${studentId}`;
			try{
				let response = await fetch(url);
				let data = await response.json();
				console.log(data);
				makeDetailHtml(data);
			} catch(error){
				console.log(error);
			}
		}
		
		function makeDetailHtml(detail){
			CURRENT_ID = detail.studentId;
			document.querySelector("#inputStudentNm").value = detail.studentNm;
			document.querySelector("#inputEmail").value = detail.email;
			document.querySelector("#inputPhone").value = detail.phone;
		}
		
		
		function clear(){
			document.querySelector("#inputStudentNm").value = "";
			document.querySelector("#inputEmail").value = "";
			document.querySelector("#inputPhone").value = "";
		}

		 async function insertStudent(){			
			let student = {
				studentNm: document.querySelector("#inputStudentNm").value,
				email: document.querySelector("#inputEmail").value,
				phone: document.querySelector("#inputPhone").value,
			};
			
			let fetchOptions = {
					method: "POST", 
					body: new URLSearchParams(student) // www.urlencoded 하지만 파일 업로드를 할때는 form-data를 이용해야한다.
					
			};
			try{
				let response = await fetch("/students", fetchOptions);
				let data = await response.json();
				console.log(data);
				listStudent();
			} catch(error){
				console.log(error);
			}
		} 
		 async function updateStudent(){			
				let student = {
					studentId: CURRENT_ID,
					studentNm: document.querySelector("#inputStudentNm").value,
					email: document.querySelector("#inputEmail").value,
					phone: document.querySelector("#inputPhone").value,
				};
				
				let fetchOptions = {
						method: "PUT", 
						body: new URLSearchParams(student) 
				};
				try{
					let response = await fetch(`/students/${CURRENT_ID}`, fetchOptions);
					let data = await response.json();
					console.log(data);
					listStudent();
				} catch(error){
					console.log(error);
				}
			}
		 
		 async function deleteStudent(){			
				
				let fetchOptions = {
						method: "DELETE" 												
				};
				try{
					let response = await fetch(`/students/${CURRENT_ID}`, fetchOptions);
					let data = await response.json();
					console.log(data);
					listStudent();
				} catch(error){
					console.log(error);
				}
			}
		 
		 async function sortStudent(){
			 console.log("sortStudent()");
			 let fetchOptions = {
					 method: "GET"
			 }
			 try{
				 let response = await fetch(`/students/sort`, fetchOptions);
				 let data = await response.json();				 
				 makeListHtml(data);
				console.log(data);
				clear();
			 } catch(error){
				console.error(error);
			}				
		 }
	</script>
</body>
</html>